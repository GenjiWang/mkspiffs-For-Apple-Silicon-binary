# mkspiffs for Apple Silicon (macOS ARM64) 執行檔
# mkspiffs Prebuilt Binary for Apple Silicon (macOS ARM64)

[![Build mkspiffs for Apple Silicon](https://github.com/GenjiWang/mkspiffs-For-Apple-Silicon-binary/actions/workflows/build.yml/badge.svg)](https://github.com/GenjiWang/mkspiffs-For-Apple-Silicon-binary/actions/workflows/build.yml)

---

[點我下載 mkspiffs_espressif32_arduino_macos_arm64](./mkspiffs_espressif32_arduino_macos_arm64)

[Download Here mkspiffs_espressif32_arduino_macos_arm64](./mkspiffs_espressif32_arduino_macos_arm64)


## 簡介 | Introduction

提供可直接在 Apple Silicon macOS 上運作的 mkspiffs 預編譯二進位檔案，方便 PlatformIO 使用 ESP32 的用戶，解決「Bad CPU type in executable」錯誤。

This repository provides a prebuilt mkspiffs binary that works on Apple Silicon macOS, so PlatformIO ESP32 developers can replace the default binary and fix the "Bad CPU type in executable" error.

---

## 使用方法 | How to use

1. **下載本頁的二進位檔案**  
   Download the binary file from this repository.

2. **複製並覆蓋 PlatformIO 舊有檔案**  
   Replace the original file in your PlatformIO tool folder with this binary  
   輸入以下指令（需將 `mkspiffs_for_Apple_Silicon` 換成你下載的實際檔名）：  
   Run the following command in terminal (replace filename as necessary):

   ```bash
   cp mkspiffs_for_Apple_Silicon ~/.platformio/packages/tool-mkspiffs/mkspiffs_espressif32_arduino
   ```

3. **重新執行 PlatformIO 建置檔案系統指令**  
   Run PlatformIO's buildfs/uploadfs as usual:

   ```bash
   pio run --target buildfs
   pio run --target uploadfs
   ```

   如果看到沒有錯誤，就代表已經修復！

---

## 注意事項 | Notes

- 若 PlatformIO 或 ESP32 關聯的套件有重大升級，可能需要**重新用新二進位替代舊檔**，以確保相容性與正常運作。

- If PlatformIO or ESP32 related packages are updated, you may need to **replace the binary again** with a newly built version to ensure compatibility and proper operation.


## 問題回報 | Issues

如果有任何問題，歡迎在本 repo 提出 issue，或補充建議、心得，讓更多人受惠！

If you have any problems or suggestions, feel free to open an issue or contribute to this repo.

---

## 自行編譯 | Build It Yourself

如果你想要自行編譯 mkspiffs，可以使用本 repo 提供的 build script：

If you want to build mkspiffs yourself, you can use the build script provided in this repository:

```bash
# Clone this repository
git clone https://github.com/GenjiWang/mkspiffs-For-Apple-Silicon-binary.git
cd mkspiffs-For-Apple-Silicon-binary

# Run the build script
./build.sh
```

或者手動編譯：

Or build manually:

```bash
# Clone mkspiffs repository
git clone --recursive https://github.com/igrr/mkspiffs.git
cd mkspiffs

# Build for Apple Silicon (arm64) with Arduino ESP32 configuration
# IMPORTANT: SPIFFS_OBJ_META_LEN=4 is required for ESP32 Arduino compatibility
make dist BUILD_CONFIG_NAME="-arduino-esp32" \
    CPPFLAGS="-DSPIFFS_OBJ_META_LEN=4" \
    TARGET_CFLAGS="-mmacosx-version-min=11.0 -arch arm64" \
    TARGET_CXXFLAGS="-mmacosx-version-min=11.0 -arch arm64 -stdlib=libc++" \
    TARGET_LDFLAGS="-mmacosx-version-min=11.0 -arch arm64 -stdlib=libc++"
```

### 為什麼直接編譯無法使用？ | Why Direct Compilation Doesn't Work?

有兩個主要原因：

There are two main reasons:

**1. 架構問題 | Architecture Issue:**

原版 mkspiffs 的 Makefile 將 macOS 編譯設定為 `i386` 和 `x86_64` 架構：

The original mkspiffs Makefile sets macOS build to `i386` and `x86_64` architectures:

```makefile
ifeq ($(TARGET_OS),osx)
    TARGET_CFLAGS   = -mmacosx-version-min=10.7 -arch i386 -arch x86_64
```

這會導致在 Apple Silicon 上執行時出現「Bad CPU type in executable」錯誤。

This causes "Bad CPU type in executable" error when running on Apple Silicon.

**2. SPIFFS 配置問題 | SPIFFS Configuration Issue:**

即使編譯成 arm64 架構，如果沒有設定正確的 SPIFFS 配置參數，產生的 binary 建立的 SPIFFS 映像將無法被 ESP32 正確讀取。

Even if compiled for arm64 architecture, without the correct SPIFFS configuration parameters, the resulting binary will create SPIFFS images that cannot be read correctly by ESP32.

對於 ESP32 Arduino，必須設定 `SPIFFS_OBJ_META_LEN=4`：

For ESP32 Arduino, you must set `SPIFFS_OBJ_META_LEN=4`:

```bash
CPPFLAGS="-DSPIFFS_OBJ_META_LEN=4"
```

這個設定確保 mkspiffs 產生的檔案系統格式與 ESP32 Arduino 框架相容。

This setting ensures the filesystem format generated by mkspiffs is compatible with the ESP32 Arduino framework.

---

## 來源 | Source

mkspiffs 專案原始碼：  
[https://github.com/igrr/mkspiffs](https://github.com/igrr/mkspiffs)
